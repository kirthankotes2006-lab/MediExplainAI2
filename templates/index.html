<!DOCTYPE html>
<html>
<head>
    <title>MediExplain AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 22px;
            font-weight: 600;
            color: #1f2937;
            margin-top: 0;
            letter-spacing: -0.3px;
        }

        p.subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.5;
        }

        .toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .toggle button {
            padding: 10px 20px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            background: #e5e7eb;
        }

        .toggle button.active {
            background: #2563eb;
            color: white;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 14px;
        }

        input[type="file"] {
            padding: 8px;
            cursor: pointer;
            background: #f9fafb;
            border: 2px dashed #2563eb;
            transition: all 0.3s ease;
        }

        input[type="file"]:hover {
            background: #eff6ff;
            border-color: #1d4ed8;
        }

        input[type="file"]::file-selector-button {
            padding: 8px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            transition: background 0.3s ease;
        }

        input[type="file"]::file-selector-button:hover {
            background: #1d4ed8;
        }

        button.submit-btn {
            margin-top: 15px;
            padding: 12px;
            width: 100%;
            border-radius: 10px;
            border: none;
            background: #2563eb;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .results {
            margin-top: 40px;
        }

        .card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
            line-height: 1.6;
        }

        .card strong {
            color: #1f2937;
            font-weight: 600;
        }

        .card div {
            color: #374151;
            font-size: 15px;
        }

        .policy-card {
            background: #dcfce7;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #86efac;
            margin-bottom: 15px;
        }

        .error {
            background: #fee2e2;
            padding: 10px;
            border-radius: 8px;
            color: #991b1b;
        }

        .loading {
            text-align: center;
            font-weight: bold;
        }

        .bar-container {
            background: #e5e7eb;
            height: 20px;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .bar {
            height: 20px;
            border-radius: 10px;
            width: 0;
            transition: width 1s ease-in-out;
        }

        .bar.billed { background: #ef4444; }
        .bar.coverage { background: #3b82f6; }
        .bar.claimable { background: #10b981; }
        .bar.mean { background: #8b5cf6; }

        .bar-label {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .risk-meter {
            margin-top: 15px;
        }

        .meter-container {
            background: #e5e7eb;
            height: 18px;
            border-radius: 9px;
            overflow: hidden;
        }

        .meter-fill {
            height: 18px;
            width: 0;
            border-radius: 9px;
            transition: width 1s ease-in-out;
        }

        .meter-low { background: #10b981; }
        .meter-medium { background: #f59e0b; }
        .meter-high { background: #ef4444; }

        .tooltip {
            position: relative;
            cursor: pointer;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #111827;
            color: #fff;
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .badge-high { background: #fee2e2; color: #b91c1c; }
        .badge-medium { background: #fef3c7; color: #92400e; }
        .badge-low { background: #dcfce7; color: #166534; }

        .chart-container {
            margin-top: 15px;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>MediExplain AI</h1>
    <p class="subtitle">Understand your medical bills, coverage & potential overpricing instantly.</p>

    <div class="card" style="background: #e0f2fe; border-left: 4px solid #0284c7; margin-bottom: 30px;">
        <strong style="color: #0c4a6e;">Active Policy:</strong>
        <div style="margin-top: 8px; color: #0c4a6e;">
            <div>Co-payment: 20%</div>
            <div>MRI Coverage: ₹15,000</div>
        </div>
    </div>

    <div class="toggle">
        <button id="manualBtn" class="active">Manual Entry</button>
        <button id="pdfBtn">Upload PDF</button>
        <button id="policyBtn">Upload Insurance Policy</button>
    </div>

    <!-- Manual Section -->
    <div id="manualSection" class="section active">
        <input id="patient_name" placeholder="Patient Name">
        <input id="hospital_name" placeholder="Hospital Name">
        <input id="treatment_name" placeholder="Treatment Name">
        <input id="treatment_cost" placeholder="Treatment Cost">
        <input id="other_name" placeholder="Other Item Name">
        <input id="other_cost" placeholder="Other Item Cost">

        <button class="submit-btn" onclick="submitManual()">Analyze Bill</button>
    </div>

    <!-- PDF Section -->
    <div id="pdfSection" class="section">
        <input type="file" id="pdfFile">
        <button class="submit-btn" onclick="submitPDF()">Upload & Analyze</button>
    </div>

    <!-- Policy Section -->
    <div id="policySection" class="section">
        <input type="file" id="policyFile" accept="application/pdf">
        <button class="submit-btn" onclick="submitPolicy()">Upload Insurance Policy</button>
        <div id="policySummary" style="margin-top:20px;"></div>
    </div>

    <div id="loading" class="loading" style="display:none;">
        Analyzing... Please wait.
    </div>

    <div id="error" style="display:none;" class="error"></div>

    <div id="results" class="results"></div>

    <!-- Q&A Section -->
    <div id="qaSection" class="section" style="display:none; margin-top: 30px;">
        <h2>Ask Questions About Your Bill</h2>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <input 
                id="userQuestion" 
                type="text" 
                placeholder="Ask about your bill, exclusions, coverage..." 
                style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
            >
            <button class="submit-btn" onclick="askLLM()" style="width: auto;">Ask</button>
        </div>
        <div id="qaAnswer" style="margin-top: 15px; padding: 15px; background: #f0f4f8; border-radius: 8px; display: none;"></div>
        <div id="qaLoading" class="loading" style="display:none; margin-top: 15px;">
            Generating answer...
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

let miniCharts = {}; // map canvasId -> Chart instance
let lastAnalysisData = null;  // Store latest analysis results for PDF download
window.lastAnalysis = null;  // Store analysis for Q&A

// Safe currency formatter: handles undefined/null and non-numeric values
function formatCurrency(value) {
    if (value === null || value === undefined || value === '') return '—';
    const n = Number(value);
    if (isNaN(n)) return String(value);
    return n.toLocaleString('en-IN', { maximumFractionDigits: 2 });
}

const manualBtn = document.getElementById("manualBtn");
const pdfBtn = document.getElementById("pdfBtn");
const policyBtn = document.getElementById("policyBtn");
const manualSection = document.getElementById("manualSection");
const pdfSection = document.getElementById("pdfSection");
const policySection = document.getElementById("policySection");

manualBtn.onclick = () => {
    manualBtn.classList.add("active");
    pdfBtn.classList.remove("active");
    policyBtn.classList.remove("active");
    manualSection.classList.add("active");
    pdfSection.classList.remove("active");
    policySection.classList.remove("active");
};

pdfBtn.onclick = () => {
    pdfBtn.classList.add("active");
    manualBtn.classList.remove("active");
    policyBtn.classList.remove("active");
    pdfSection.classList.add("active");
    manualSection.classList.remove("active");
    policySection.classList.remove("active");
};

policyBtn.onclick = () => {
    policyBtn.classList.add("active");
    manualBtn.classList.remove("active");
    pdfBtn.classList.remove("active");

    policySection.classList.add("active");
    manualSection.classList.remove("active");
    pdfSection.classList.remove("active");
};

function showLoading(show) {
    document.getElementById("loading").style.display = show ? "block" : "none";
}

function showError(message) {
    const error = document.getElementById("error");
    error.innerText = message;
    error.style.display = "block";
}

function clearError() {
    document.getElementById("error").style.display = "none";
}

function displayPolicySummary(policy) {
    const summary = document.getElementById("policySummary");
    
    let coverageList = "No coverage information";
    if (policy.covered_treatments && Array.isArray(policy.covered_treatments)) {
        coverageList = `<ul style="margin: 8px 0; padding-left: 20px;">${policy.covered_treatments.map(item => `<li>${item}</li>`).join("")}</ul>`;
    }
    
    let exclusionsList = "No exclusions";
    if (policy.exclusions && Array.isArray(policy.exclusions)) {
        exclusionsList = `<ul style="margin: 8px 0; padding-left: 20px;">${policy.exclusions.map(item => `<li>${item}</li>`).join("")}</ul>`;
    }
    
    summary.innerHTML = `
        <div class="policy-card">
            <strong style="color: #166534;">Active Policy Status</strong>
            <div style="margin-top: 12px; color: #166534;">
                <div><strong>Co-payment:</strong> ${policy.co_payment || "N/A"}%</div>
                <div style="margin-top: 8px;"><strong>Covered Treatments:</strong>${coverageList}</div>
                <div style="margin-top: 8px;"><strong>Exclusions:</strong>${exclusionsList}</div>
            </div>
        </div>
    `;
}

function drawMiniChart(canvasId, data, billedCost, label) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || typeof Chart === 'undefined') return;

    // Destroy existing chart if present
    if (miniCharts[canvasId]) {
        try { miniCharts[canvasId].destroy(); } catch (e) { /* ignore */ }
        delete miniCharts[canvasId];
    }

    const ctx = canvas.getContext('2d');
    // Ensure we have numeric array
    const series = Array.isArray(data) ? data.map(v => Number(v) || 0) : [];
    if (series.length === 0) {
        // create an empty chart with a message-like single point
        miniCharts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: { labels: [''], datasets: [{ data: [0], borderColor: '#cbd5e1', borderWidth: 1, pointRadius: 0 }] },
            options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
        });
        return;
    }

    const labels = series.map((_, i) => `T${i+1}`);

    // dataset for historical trend
    const datasets = [{
        label: label || 'History',
        data: series,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59,130,246,0.08)',
        tension: 0.3,
        pointRadius: 3,
        fill: true,
    }];

    // horizontal billed cost line as another dataset
    const billedSeries = series.map(() => billedCost || 0);
    datasets.push({
        label: 'Billed',
        data: billedSeries,
        borderColor: '#ef4444',
        borderWidth: 1.5,
        pointRadius: 0,
        borderDash: [6,4],
        fill: false,
    });

    miniCharts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                x: { display: false },
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            },
            onClick: (evt, elements, chart) => {
                if (!elements || elements.length === 0) return;
                const el = elements[0];
                const idx = el.index;
                const val = chart.data.datasets[0].data[idx];
                // show brief interactive feedback
                alert(`${label || 'Treatment'} — Historical point ${idx+1}: ₹${val}`);
            }
        }
    });
}

function displayResults(data) {
    lastAnalysisData = data;  // Store for PDF download
    const results = document.getElementById("results");
    const analysis = data.analysis || data;

    let comparisonHTML = "";

    if (analysis.coverage_breakdown && analysis.coverage_breakdown.length > 0) {
        analysis.coverage_breakdown.forEach((item, index) => {

            const billed = item.billed_cost;
            const coverage = item.coverage_limit;
            const claimable = item.claimable_amount;
            const mean = item.mean_cost || 0;
            const std_dev = item.std_dev || 0;

            const maxValue = Math.max(billed, coverage, mean);

            const billedPercent = (billed / maxValue) * 100;
            const coveragePercent = (coverage / maxValue) * 100;
            const claimablePercent = (claimable / maxValue) * 100;
            const meanPercent = (mean / maxValue) * 100;

            // Calculate deviation
            const deviation = mean > 0 ? ((billed - mean) / mean) * 100 : 0;
            
            let badgeClass = "badge-low";
            if (deviation > 50) badgeClass = "badge-high";
            else if (deviation > 20) badgeClass = "badge-medium";

            // Risk logic
            let riskPercent = 20;
            let riskClass = "meter-low";

            if (analysis.cost_efficiency_warnings.length > 0) {
                riskPercent = 80;
                riskClass = "meter-high";
            } else if (billed > coverage) {
                riskPercent = 50;
                riskClass = "meter-medium";
            }

            comparisonHTML += `
                <div class="card">
                    <strong>${item.treatment_name}</strong>
                    <span class="badge ${badgeClass}">
                        ${deviation.toFixed(1)}% above mean
                    </span>
                    
                    <div class="tooltip">
                        ℹ️
                        <span class="tooltiptext">
                            This cost is ${deviation.toFixed(1)}% above historical average.
                            Mean: ₹${mean.toFixed(0)}, Std Dev: ₹${std_dev.toFixed(0)}
                        </span>
                    </div><br><br>

                    <div class="bar-label">Billed: ₹${billed}</div>
                    <div class="bar-container">
                        <div class="bar billed" id="billed-${index}"></div>
                    </div>

                    <div class="bar-label">Coverage Limit: ₹${coverage}</div>
                    <div class="bar-container">
                        <div class="bar coverage" id="coverage-${index}"></div>
                    </div>

                    <div class="bar-label">Final Claimable: ₹${claimable}</div>
                    <div class="bar-container">
                        <div class="bar claimable" id="claimable-${index}"></div>
                    </div>

                    <div class="bar-label">Market Mean: ₹${mean}</div>
                    <div class="bar-container">
                        <div class="bar mean" id="mean-${index}"></div>
                    </div>

                    <div class="risk-meter">
                        <strong>Risk Level</strong>
                        <div class="meter-container">
                            <div class="meter-fill ${riskClass}" id="risk-${index}"></div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="chart-${index}" width="300" height="80"></canvas>
                    </div>
                </div>
            `;
        });
    }

    results.innerHTML = `
        <h2>Analysis Results</h2>
        ${comparisonHTML}
        <div class="card"><strong>Total Bill:</strong> ₹${formatCurrency(analysis.total_bill_amount)}</div>
        <div class="card"><strong>Final Claimable:</strong> ₹${formatCurrency(analysis.final_claimable_amount)}</div>
        <div class="card"><strong>Co-payment:</strong> ₹${formatCurrency(analysis.co_payment_deducted)}</div>
        <div class="card" style="background: #f0f9ff; border: 1px solid #0284c7; margin-top: 20px;"><strong style="color: #0c4a6e;">Explanation:</strong><br><div style="margin-top: 10px; color: #0c4a6e; line-height: 1.8; white-space: pre-wrap;">${(data.explanation || '').replace(/\*+/g, '')}</div></div>
        <button class="submit-btn" onclick="downloadReport()">Download Report (PDF)</button>
    `;

    // Store analysis for Q&A
    window.lastAnalysis = analysis;
    document.getElementById("qaSection").style.display = "block";
    document.getElementById("userQuestion").value = "";
    document.getElementById("qaAnswer").style.display = "none";

    // Animate bars after rendering
    setTimeout(() => {
        analysis.coverage_breakdown.forEach((item, index) => {

            const billed = item.billed_cost;
            const coverage = item.coverage_limit;
            const claimable = item.claimable_amount;
            const mean = item.mean_cost || 0;

            const maxValue = Math.max(billed, coverage, mean);

            document.getElementById(`billed-${index}`).style.width =
                (billed / maxValue) * 100 + "%";

            document.getElementById(`coverage-${index}`).style.width =
                (coverage / maxValue) * 100 + "%";

            document.getElementById(`claimable-${index}`).style.width =
                (claimable / maxValue) * 100 + "%";

            document.getElementById(`mean-${index}`).style.width =
                (mean / maxValue) * 100 + "%";

            let riskWidth = 20;
            if (analysis.cost_efficiency_warnings.length > 0) riskWidth = 80;
            else if (billed > coverage) riskWidth = 50;

            document.getElementById(`risk-${index}`).style.width =
                riskWidth + "%";

            // Draw mini chart
            drawMiniChart(`chart-${index}`, item.historical_trend || [], billed, item.treatment_name || 'Treatment');
        });
    }, 100);
}

async function submitManual() {
    clearError();
    showLoading(true);

    try {
        const response = await fetch("/billing/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                patient_name: patient_name.value,
                hospital_name: hospital_name.value,
                treatments: [{
                    name: treatment_name.value,
                    cost: parseFloat(treatment_cost.value)
                }],
                other_items: [{
                    name: other_name.value,
                    cost: parseFloat(other_cost.value)
                }]
            })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || "Error occurred");

        displayResults(data);

    } catch (err) {
        showError(err.message);
    }

    showLoading(false);
}

async function submitPDF() {
    clearError();
    showLoading(true);

    const formData = new FormData();
    formData.append("file", pdfFile.files[0]);

    try {
        const response = await fetch("/api/billing/upload", {
            method: "POST",
            body: formData
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || "Upload failed");

        displayResults(data);

    } catch (err) {
        showError(err.message);
    }

    showLoading(false);
}

async function submitPolicy() {
    clearError();
    showLoading(true);

    const formData = new FormData();
    formData.append("file", document.getElementById("policyFile").files[0]);

    try {
        const response = await fetch("/billing/upload-policy", {
            method: "POST",
            body: formData
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || "Policy upload failed");

        document.getElementById("policySummary").innerHTML = `
            <div class="card" style="background:#ecfdf5;border:1px solid #10b981;">
                <strong>Active Policy Loaded</strong><br>
                Co-payment: ${data.co_payment_percentage}%<br>
                Coverage: ${Object.keys(data.coverage_limits).join(", ")}<br>
                Exclusions: ${data.exclusions.join(", ")}
            </div>
        `;

    } catch (err) {
        showError(err.message);
    }

    showLoading(false);
}

async function downloadReport() {
    if (!lastAnalysisData) {
        showError("No analysis data available. Please analyze a bill first.");
        return;
    }

    try {
        const response = await fetch("/billing/download-report", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(lastAnalysisData)
        });
        
        if (!response.ok) throw new Error("Failed to download report");
        
        const blob = await response.blob();
        const link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);
        link.download = "MediExplain_Report.pdf";
        link.click();
        window.URL.revokeObjectURL(link.href);
    } catch (err) {
        showError("Failed to download report: " + err.message);
    }
}

async function askLLM() {
    const question = document.getElementById("userQuestion").value.trim();
    
    if (!question) {
        showError("Please enter a question");
        return;
    }

    if (!window.lastAnalysis) {
        showError("No analysis available. Please analyze a bill first.");
        return;
    }

    const qaLoading = document.getElementById("qaLoading");
    const qaAnswer = document.getElementById("qaAnswer");
    
    qaLoading.style.display = "block";
    qaAnswer.style.display = "none";
    clearError();

    try {
        const response = await fetch("/api/billing/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                question: question,
                analysis: window.lastAnalysis
            })
        });

        if (!response.ok) {
            throw new Error("Failed to get answer");
        }

        const data = await response.json();
        qaAnswer.innerHTML = `<strong>Answer:</strong><br>${data.answer}`;
        qaAnswer.style.display = "block";
    } catch (err) {
        showError("Error getting answer: " + err.message);
    } finally {
        qaLoading.style.display = "none";
    }
}

</script>

</body>
</html>