<!DOCTYPE html>
<html>
<head>
    <title>MediExplain AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.08);
        }

        h1 {
            text-align: center;
            margin: 0 0 8px 0;
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }

        h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin: 28px 0 18px 0;
            letter-spacing: -0.5px;
        }

        p.subtitle {
            text-align: center;
            color: #6b7280;
            margin: 0 0 32px 0;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
        }

        .toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .toggle button {
            padding: 11px 24px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            background: white;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle button:hover {
            border-color: #2563eb;
            color: #2563eb;
        }

        .toggle button.active {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        input {
            width: 100%;
            padding: 12px 14px;
            margin: 10px 0;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        input:hover {
            border-color: #d1d5db;
            background: white;
        }

        input:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        input[type="file"] {
            padding: 8px;
            cursor: pointer;
            background: #f9fafb;
            border: 2px dashed #2563eb;
            transition: all 0.3s ease;
        }

        input[type="file"]:hover {
            background: #eff6ff;
            border-color: #1d4ed8;
        }

        input[type="file"]::file-selector-button {
            padding: 8px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            transition: background 0.3s ease;
        }

        input[type="file"]::file-selector-button:hover {
            background: #1d4ed8;
        }

        button.submit-btn {
            margin-top: 16px;
            padding: 13px;
            width: 100%;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.2);
        }

        button.submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(37, 99, 235, 0.3);
        }

        button.submit-btn:active {
            transform: translateY(0);
        }

        button.submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results {
            margin-top: 40px;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .card {
            background: #f9fafb;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
            line-height: 1.7;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #d1d5db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .card strong {
            color: #1f2937;
            font-weight: 700;
        }

        .card div {
            color: #374151;
            font-size: 15px;
            margin: 6px 0;
        }

        .policy-card {
            background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%);
            padding: 18px;
            border-radius: 12px;
            border: 2px solid #86efac;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .policy-card:hover {
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.15);
        }

        .error {
            background: #fef2f2;
            padding: 14px 16px;
            border-radius: 10px;
            color: #991b1b;
            border-left: 4px solid #dc2626;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInDown 0.3s ease;
        }

        .error::before {
            content: "‚ö†Ô∏è";
            font-size: 18px;
            flex-shrink: 0;
        }

        .loading {
            text-align: center;
            font-weight: 600;
            color: #2563eb;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 15px;
        }

        .loading::before {
            content: "";
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bar-container {
            background: #e5e7eb;
            height: 24px;
            border-radius: 12px;
            margin-bottom: 14px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .bar {
            height: 24px;
            border-radius: 12px;
            width: 0;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .bar::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .bar.billed { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .bar.coverage { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .bar.claimable { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .bar.mean { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }

        .bar-label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #374151;
        }

        .risk-meter {
            margin-top: 20px;
        }

        .risk-meter strong {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meter-container {
            background: #e5e7eb;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        .meter-fill {
            height: 20px;
            width: 0;
            border-radius: 10px;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .meter-fill::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        .meter-low { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .meter-medium { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .meter-high { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

        .tooltip {
            position: relative;
            cursor: pointer;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            padding: 10px 12px;
            border-radius: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -120px;
            font-size: 13px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-high { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #7f1d1d; }
        .badge-medium { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #78350f; }
        .badge-low { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #165e4d; }

        .chart-container {
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            padding: 12px;
            border: 1px solid #e5e7eb;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                padding: 20px;
            }

            h1 {
                font-size: 28px;
            }

            h2 {
                font-size: 20px;
            }

            .toggle {
                flex-direction: column;
            }

            .toggle button {
                width: 100%;
            }

            input[type="file"]::file-selector-button {
                display: block;
                width: 100%;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align: center; margin-bottom: 32px;">
        <!-- Logo -->
        <svg width="72" height="72" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 16px; filter: drop-shadow(0 4px 12px rgba(37, 99, 235, 0.2));">
            <!-- Medical Cross -->
            <circle cx="36" cy="36" r="36" fill="url(#logoGradient)" opacity="0.1"/>
            <rect x="32" y="24" width="8" height="24" fill="#2563eb" rx="4"/>
            <rect x="24" y="32" width="24" height="8" fill="#2563eb" rx="4"/>
            <!-- Chart bars -->
            <g transform="translate(28, 48)">
                <rect x="0" y="6" width="3" height="6" fill="#10b981" rx="1.5"/>
                <rect x="5" y="4" width="3" height="8" fill="#3b82f6" rx="1.5"/>
                <rect x="10" y="2" width="3" height="10" fill="#8b5cf6" rx="1.5"/>
            </g>
            <defs>
                <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#2563eb;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#1e40af;stop-opacity:1" />
                </linearGradient>
            </defs>
        </svg>
        
        <h1>MediExplain AI</h1>
        
        <p class="subtitle">Understand your medical bills, coverage & potential overpricing instantly.</p>
        
        <!-- Feature highlights -->
        <div style="display: flex; justify-content: center; gap: 24px; margin-bottom: 32px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 150px; padding: 12px; border-radius: 10px; background: rgba(37, 99, 235, 0.05); border: 1px solid rgba(37, 99, 235, 0.1);">
                <div style="font-size: 20px; margin-bottom: 6px;">üìä</div>
                <div style="font-size: 13px; font-weight: 600; color: #1f2937;">Smart Analysis</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">AI-powered cost insights</div>
            </div>
            <div style="flex: 1; min-width: 150px; padding: 12px; border-radius: 10px; background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.1);">
                <div style="font-size: 20px; margin-bottom: 6px;">üõ°Ô∏è</div>
                <div style="font-size: 13px; font-weight: 600; color: #1f2937;">Coverage Clarity</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">Know what's covered</div>
            </div>
            <div style="flex: 1; min-width: 150px; padding: 12px; border-radius: 10px; background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.1);">
                <div style="font-size: 20px; margin-bottom: 6px;">üí°</div>
                <div style="font-size: 13px; font-weight: 600; color: #1f2937;">Smart Q&A</div>
                <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">Ask questions anytime</div>
            </div>
        </div>
    </div>

    <div class="card" style="background: linear-gradient(135deg, #e0f2fe 0%, #cffafe 100%); border-left: 4px solid #0284c7; margin-bottom: 30px;">
        <strong style="color: #0c4a6e; display: flex; align-items: center; gap: 8px;">
            <span>üìã</span> Active Policy
        </strong>
        <div style="margin-top: 12px; color: #0c4a6e;">
            <div>üí∞ Co-payment: 20%</div>
            <div style="margin-top: 6px;">üè• MRI Coverage: ‚Çπ15,000</div>
        </div>
    </div>

    <div class="toggle">
        <button id="manualBtn" class="active">Manual Entry</button>
        <button id="pdfBtn">Upload PDF</button>
        <button id="policyBtn">Upload Insurance Policy</button>
    </div>

    <!-- Manual Section -->
    <div id="manualSection" class="section active">
        <h3 style="margin-top: 0; color: #1f2937; font-size: 18px; margin-bottom: 20px;">üìù Enter Bill Details</h3>
        <input id="patient_name" placeholder="Patient Name" aria-label="Patient Name">
        <input id="hospital_name" placeholder="Hospital Name" aria-label="Hospital Name">
        <input id="treatment_name" placeholder="Treatment Name" aria-label="Treatment Name">
        <input id="treatment_cost" type="number" placeholder="Treatment Cost (‚Çπ)" aria-label="Treatment Cost">
        <input id="other_name" placeholder="Other Item Name" aria-label="Other Item Name">
        <input id="other_cost" type="number" placeholder="Other Item Cost (‚Çπ)" aria-label="Other Item Cost">

        <button class="submit-btn" onclick="submitManual()">üìä Analyze Bill</button>
    </div>

    <!-- PDF Section -->
    <div id="pdfSection" class="section">
        <h3 style="margin-top: 0; color: #1f2937; font-size: 18px; margin-bottom: 20px;">üìÑ Upload Medical Bill PDF</h3>
        <input type="file" id="pdfFile" aria-label="Upload PDF file">
        <button class="submit-btn" onclick="submitPDF()">üìä Upload & Analyze</button>
    </div>

    <!-- Policy Section -->
    <div id="policySection" class="section">
        <h3 style="margin-top: 0; color: #1f2937; font-size: 18px; margin-bottom: 20px;">üõ°Ô∏è Upload Insurance Policy</h3>
        <input type="file" id="policyFile" accept="application/pdf" aria-label="Upload policy PDF">
        <button class="submit-btn" onclick="submitPolicy()">üìã Upload Insurance Policy</button>
        <div id="policySummary" style="margin-top:20px;"></div>
    </div>

    <div id="loading" class="loading" style="display:none;" aria-live="polite" aria-busy="true">
        Analyzing... Please wait.
    </div>

    <div id="error" style="display:none;" class="error"></div>

    <div id="results" class="results"></div>

    <!-- Q&A Section -->
    <div id="qaSection" class="section" style="display:none; margin-top: 40px; padding: 24px; background: linear-gradient(135deg, #f0f4f8 0%, #e6f0ff 100%); border-radius: 16px; border: 2px solid #dbeafe;">
        <h2 style="margin-top: 0; color: #1e40af;">üí¨ Ask Questions About Your Bill</h2>
        <p style="color: #3730a3; font-size: 14px; margin: 10px 0 18px 0;">Get instant answers about coverage, claims, and your analysis.</p>
        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
            <input 
                id="userQuestion" 
                type="text" 
                placeholder="Ask about your bill, exclusions, coverage..." 
                aria-label="Your question about the bill"
                style="flex: 1; min-width: 200px; padding: 12px 14px; border: 2px solid #dbeafe; border-radius: 10px; font-size: 14px; background: white; transition: all 0.3s ease;"
            >
            <button class="submit-btn" onclick="askLLM()" style="width: auto; min-width: 120px; padding: 12px 20px; margin-top: 0;">ü§ñ Ask</button>
        </div>
        <div id="qaAnswer" style="margin-top: 18px; padding: 16px; background: white; border-radius: 12px; display: none; border-left: 4px solid #2563eb; line-height: 1.8; color: #374151;"></div>
        <div id="qaLoading" class="loading" style="display:none; margin-top: 15px; color: #2563eb;">
            Generating answer...
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

let miniCharts = {}; // map canvasId -> Chart instance
let lastAnalysisData = null;  // Store latest analysis results for PDF download
window.lastAnalysis = null;  // Store analysis for Q&A

// Safe currency formatter: handles undefined/null and non-numeric values
function formatCurrency(value) {
    if (value === null || value === undefined || value === '') return '‚Äî';
    const n = Number(value);
    if (isNaN(n)) return String(value);
    return n.toLocaleString('en-IN', { maximumFractionDigits: 2 });
}

const manualBtn = document.getElementById("manualBtn");
const pdfBtn = document.getElementById("pdfBtn");
const policyBtn = document.getElementById("policyBtn");
const manualSection = document.getElementById("manualSection");
const pdfSection = document.getElementById("pdfSection");
const policySection = document.getElementById("policySection");

manualBtn.onclick = () => {
    manualBtn.classList.add("active");
    pdfBtn.classList.remove("active");
    policyBtn.classList.remove("active");
    manualSection.classList.add("active");
    pdfSection.classList.remove("active");
    policySection.classList.remove("active");
};

pdfBtn.onclick = () => {
    pdfBtn.classList.add("active");
    manualBtn.classList.remove("active");
    policyBtn.classList.remove("active");
    pdfSection.classList.add("active");
    manualSection.classList.remove("active");
    policySection.classList.remove("active");
};

policyBtn.onclick = () => {
    policyBtn.classList.add("active");
    manualBtn.classList.remove("active");
    pdfBtn.classList.remove("active");

    policySection.classList.add("active");
    manualSection.classList.remove("active");
    pdfSection.classList.remove("active");
};

function showLoading(show) {
    document.getElementById("loading").style.display = show ? "block" : "none";
}

function showError(message) {
    const error = document.getElementById("error");
    error.innerText = message;
    error.style.display = "block";
}

function clearError() {
    document.getElementById("error").style.display = "none";
}

function displayPolicySummary(policy) {
    const summary = document.getElementById("policySummary");
    
    let coverageList = "No coverage information";
    if (policy.covered_treatments && Array.isArray(policy.covered_treatments)) {
        coverageList = `<ul style="margin: 8px 0; padding-left: 20px;">${policy.covered_treatments.map(item => `<li>${item}</li>`).join("")}</ul>`;
    }
    
    let exclusionsList = "No exclusions";
    if (policy.exclusions && Array.isArray(policy.exclusions)) {
        exclusionsList = `<ul style="margin: 8px 0; padding-left: 20px;">${policy.exclusions.map(item => `<li>${item}</li>`).join("")}</ul>`;
    }
    
    summary.innerHTML = `
        <div class="policy-card">
            <strong style="color: #166534;">Active Policy Status</strong>
            <div style="margin-top: 12px; color: #166534;">
                <div><strong>Co-payment:</strong> ${policy.co_payment || "N/A"}%</div>
                <div style="margin-top: 8px;"><strong>Covered Treatments:</strong>${coverageList}</div>
                <div style="margin-top: 8px;"><strong>Exclusions:</strong>${exclusionsList}</div>
            </div>
        </div>
    `;
}

function drawMiniChart(canvasId, data, billedCost, label) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || typeof Chart === 'undefined') return;

    // Destroy existing chart if present
    if (miniCharts[canvasId]) {
        try { miniCharts[canvasId].destroy(); } catch (e) { /* ignore */ }
        delete miniCharts[canvasId];
    }

    const ctx = canvas.getContext('2d');
    // Ensure we have numeric array
    const series = Array.isArray(data) ? data.map(v => Number(v) || 0) : [];
    if (series.length === 0) {
        // create an empty chart with a message-like single point
        miniCharts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: { labels: [''], datasets: [{ data: [0], borderColor: '#cbd5e1', borderWidth: 1, pointRadius: 0 }] },
            options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
        });
        return;
    }

    const labels = series.map((_, i) => `T${i+1}`);

    // dataset for historical trend
    const datasets = [{
        label: label || 'History',
        data: series,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59,130,246,0.08)',
        tension: 0.3,
        pointRadius: 3,
        fill: true,
    }];

    // horizontal billed cost line as another dataset
    const billedSeries = series.map(() => billedCost || 0);
    datasets.push({
        label: 'Billed',
        data: billedSeries,
        borderColor: '#ef4444',
        borderWidth: 1.5,
        pointRadius: 0,
        borderDash: [6,4],
        fill: false,
    });

    miniCharts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                x: { display: false },
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            },
            onClick: (evt, elements, chart) => {
                if (!elements || elements.length === 0) return;
                const el = elements[0];
                const idx = el.index;
                const val = chart.data.datasets[0].data[idx];
                // show brief interactive feedback
                alert(`${label || 'Treatment'} ‚Äî Historical point ${idx+1}: ‚Çπ${val}`);
            }
        }
    });
}

function displayResults(data) {
    lastAnalysisData = data;  // Store for PDF download
    const results = document.getElementById("results");
    const analysis = data.analysis || data;

    let comparisonHTML = "";

    if (analysis.coverage_breakdown && analysis.coverage_breakdown.length > 0) {
        analysis.coverage_breakdown.forEach((item, index) => {

            const billed = item.billed_cost;
            const coverage = item.coverage_limit;
            const claimable = item.claimable_amount;
            const mean = item.mean_cost || 0;
            const std_dev = item.std_dev || 0;

            const maxValue = Math.max(billed, coverage, mean);

            const billedPercent = (billed / maxValue) * 100;
            const coveragePercent = (coverage / maxValue) * 100;
            const claimablePercent = (claimable / maxValue) * 100;
            const meanPercent = (mean / maxValue) * 100;

            // Calculate deviation
            const deviation = mean > 0 ? ((billed - mean) / mean) * 100 : 0;
            
            let badgeClass = "badge-low";
            if (deviation > 50) badgeClass = "badge-high";
            else if (deviation > 20) badgeClass = "badge-medium";

            // Risk logic
            let riskPercent = 20;
            let riskClass = "meter-low";

            if (analysis.cost_efficiency_warnings.length > 0) {
                riskPercent = 80;
                riskClass = "meter-high";
            } else if (billed > coverage) {
                riskPercent = 50;
                riskClass = "meter-medium";
            }

            comparisonHTML += `
                <div class="card">
                    <strong>${item.treatment_name}</strong>
                    <span class="badge ${badgeClass}">
                        ${deviation.toFixed(1)}% above mean
                    </span>
                    
                    <div class="tooltip">
                        ‚ÑπÔ∏è
                        <span class="tooltiptext">
                            This cost is ${deviation.toFixed(1)}% above historical average.
                            Mean: ‚Çπ${mean.toFixed(0)}, Std Dev: ‚Çπ${std_dev.toFixed(0)}
                        </span>
                    </div><br><br>

                    <div class="bar-label">Billed: <strong style="color: #dc2626;">‚Çπ${formatCurrency(billed)}</strong></div>
                    <div class="bar-container">
                        <div class="bar billed" id="billed-${index}"></div>
                    </div>

                    <div class="bar-label">Coverage Limit: <strong style="color: #7c3aed;">‚Çπ${formatCurrency(coverage)}</strong></div>
                    <div class="bar-container">
                        <div class="bar coverage" id="coverage-${index}"></div>
                    </div>

                    <div class="bar-label">Final Claimable: <strong style="color: #16a34a;">‚Çπ${formatCurrency(claimable)}</strong></div>
                    <div class="bar-container">
                        <div class="bar claimable" id="claimable-${index}"></div>
                    </div>

                    <div class="bar-label">Market Mean: <strong style="color: #0284c7;">‚Çπ${formatCurrency(mean)}</strong></div>
                    <div class="bar-container">
                        <div class="bar mean" id="mean-${index}"></div>
                    </div>

                    <div class="risk-meter">
                        <strong>Risk Level</strong>
                        <div class="meter-container">
                            <div class="meter-fill ${riskClass}" id="risk-${index}"></div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="chart-${index}" width="300" height="80"></canvas>
                    </div>
                </div>
            `;
        });
    }

    // Calculate savings and percentages for summary
    const totalBill = analysis.total_bill_amount || 0;
    const claimable = analysis.total_claimable_amount || analysis.final_claimable_amount || 0;
    const notCovered = totalBill - claimable;
    const claimablePercent = totalBill > 0 ? ((claimable / totalBill) * 100).toFixed(1) : 0;
    const coPayment = analysis.co_payment_deducted || 0;
    const priceAlternatives = analysis.price_alternatives || [];
    const hasPolicyInfo = (analysis.co_payment_deducted !== undefined && analysis.co_payment_deducted !== null);
    
    // Build policy info section (only if policy is loaded)
    let policySection = '';
    if (hasPolicyInfo) {
        policySection = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div class="card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-left: 4px solid #16a34a;">
                <div style="font-size: 12px; color: #15803d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">‚úÖ Claimable Amount</div>
                <div style="font-size: 24px; color: #15803d; font-weight: 800;">‚Çπ${formatCurrency(claimable)}</div>
                <div style="font-size: 11px; color: #4b7c0f; margin-top: 6px;">${claimablePercent}% of total bill</div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #fef3c7 0%, #fef08a 100%); border-left: 4px solid #d97706;">
                <div style="font-size: 12px; color: #92400e; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">üí≥ Co-Payment (15%)</div>
                <div style="font-size: 24px; color: #b45309; font-weight: 800;">‚Çπ${formatCurrency(coPayment)}</div>
                <div style="font-size: 11px; color: #a16207; margin-top: 6px;">Your deductible</div>
            </div>
        </div>
        
        <div class="card" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid #dc2626; margin-bottom: 20px;">
            <div style="font-size: 12px; color: #7f1d1d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">‚ö†Ô∏è Not Covered</div>
            <div style="font-size: 24px; color: #b91c1c; font-weight: 800;">‚Çπ${formatCurrency(notCovered)}</div>
            <div style="font-size: 11px; color: #991b1b; margin-top: 6px;">${((notCovered / totalBill) * 100).toFixed(1)}% not covered</div>
        </div>
        `;
    }
    
    // Build price alternatives section
    let priceAltSection = '';
    if (priceAlternatives && priceAlternatives.length > 0) {
        priceAltSection = `
        <div class="card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; margin-bottom: 20px;">
            <strong style="color: #92400e; display: block; margin-bottom: 15px; font-size: 16px;">üí° Better Price Options Available</strong>
            <div style="font-size: 13px; color: #78350f; margin-bottom: 15px;">We found items with overpricing. Consider these alternatives to save money:</div>
            ${priceAlternatives.map(alt => `
                <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #f59e0b;">
                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 8px;">üìå ${alt.item_name}</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; margin-bottom: 10px;">
                        <div><span style="color: #666;">Billed at:</span> <strong style="color: #dc2626;">‚Çπ${formatCurrency(alt.billed_price)}</strong></div>
                        <div><span style="color: #666;">Cheapest available:</span> <strong style="color: #059669;">‚Çπ${formatCurrency(alt.cheapest_price)}</strong></div>
                    </div>
                    <div style="background: #fef3c7; padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                        <div style="color: #b45309; font-weight: 700; font-size: 13px;">üí∞ You can save ‚Çπ${formatCurrency(alt.savings_amount)} (${alt.savings_percent}%)</div>
                        <div style="color: #92400e; font-size: 11px; margin-top: 4px;">Use: ${alt.cheapest_option}</div>
                    </div>
                    ${alt.alternatives && alt.alternatives.length > 0 ? `
                        <div style="font-size: 11px; color: #666;">
                            <strong style="display: block; margin-bottom: 6px;">Other options:</strong>
                            ${alt.alternatives.map(opt => `
                                <div style="padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                    ‚Ä¢ ${opt.brand || opt.provider} - <strong style="color: #059669;">‚Çπ${formatCurrency(opt.price)}</strong>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('')}
        </div>
        `;
    }

    results.innerHTML = `
        <h2>üìä Analysis Results</h2>
        ${comparisonHTML}
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div class="card" style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #2563eb;">
                <div style="font-size: 12px; color: #1e40af; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">üí∞ Total Bill Amount</div>
                <div style="font-size: 24px; color: #1e40af; font-weight: 800;">‚Çπ${formatCurrency(totalBill)}</div>
            </div>
            <div class="card" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid #dc2626;">
                <div style="font-size: 12px; color: #7f1d1d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">‚ö†Ô∏è Unwanted Expenses</div>
                <div style="font-size: 24px; color: #b91c1c; font-weight: 800;">‚Çπ${formatCurrency(notCovered)}</div>
                <div style="font-size: 11px; color: #991b1b; margin-top: 6px;">Verify these charges with hospital</div>
            </div>
        </div>
        
        ${policySection}
        ${priceAltSection}

        <div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0284c7; margin-bottom: 20px;"><strong style="color: #0c4a6e; display: block; margin-bottom: 10px;">üìù Analysis:</strong><div style="margin-top: 10px; color: #0c4a6e; line-height: 1.8; white-space: pre-wrap;">${(data.explanation || '').replace(/\*+/g, '').replace(/\$/g, '‚Çπ')}</div></div>
        <button class="submit-btn" onclick="downloadReport()" style="margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;"><span>üì• Download Report (PDF)</span></button>
    `;

    // Store analysis for Q&A
    window.lastAnalysis = analysis;
    document.getElementById("qaSection").style.display = "block";
    document.getElementById("userQuestion").value = "";
    document.getElementById("qaAnswer").style.display = "none";

    // Animate bars after rendering
    setTimeout(() => {
        analysis.coverage_breakdown.forEach((item, index) => {

            const billed = item.billed_cost;
            const coverage = item.coverage_limit;
            const claimable = item.claimable_amount;
            const mean = item.mean_cost || 0;

            const maxValue = Math.max(billed, coverage, mean);

            document.getElementById(`billed-${index}`).style.width =
                (billed / maxValue) * 100 + "%";

            document.getElementById(`coverage-${index}`).style.width =
                (coverage / maxValue) * 100 + "%";

            document.getElementById(`claimable-${index}`).style.width =
                (claimable / maxValue) * 100 + "%";

            document.getElementById(`mean-${index}`).style.width =
                (mean / maxValue) * 100 + "%";

            let riskWidth = 20;
            if (analysis.cost_efficiency_warnings.length > 0) riskWidth = 80;
            else if (billed > coverage) riskWidth = 50;

            document.getElementById(`risk-${index}`).style.width =
                riskWidth + "%";

            // Draw mini chart
            drawMiniChart(`chart-${index}`, item.historical_trend || [], billed, item.treatment_name || 'Treatment');
        });
    }, 100);
}

async function submitManual() {
    clearError();
    
    // Validation
    const patientName = document.getElementById("patient_name").value.trim();
    const hospitalName = document.getElementById("hospital_name").value.trim();
    const treatmentName = document.getElementById("treatment_name").value.trim();
    const treatmentCost = parseFloat(document.getElementById("treatment_cost").value);

    if (!patientName || !hospitalName || !treatmentName) {
        showError("Please fill in all required fields (Patient, Hospital, Treatment)");
        return;
    }

    if (isNaN(treatmentCost) || treatmentCost <= 0) {
        showError("Please enter a valid treatment cost");
        return;
    }

    showLoading(true);

    try {
        const response = await fetch("/billing/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                patient_name: patientName,
                hospital_name: hospitalName,
                treatments: [{
                    name: treatmentName,
                    cost: treatmentCost
                }],
                other_items: [{
                    name: document.getElementById("other_name").value.trim() || "N/A",
                    cost: parseFloat(document.getElementById("other_cost").value) || 0
                }]
            })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || "Error occurred");

        displayResults(data);

    } catch (err) {
        showError("‚ùå " + err.message);
    }

    showLoading(false);
}

async function submitPDF() {
    clearError();
    
    if (!pdfFile.files[0]) {
        showError("Please select a PDF file");
        return;
    }

    if (!pdfFile.files[0].name.toLowerCase().endsWith('.pdf')) {
        showError("Please select a valid PDF file");
        return;
    }

    showLoading(true);

    const formData = new FormData();
    formData.append("file", pdfFile.files[0]);

    try {
        const response = await fetch("/api/billing/upload", {
            method: "POST",
            body: formData
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || "Upload failed");

        displayResults(data);

    } catch (err) {
        showError("‚ùå " + err.message);
    }

    showLoading(false);
}

async function submitPolicy() {
    clearError();

    const policyFile = document.getElementById("policyFile").files[0];
    if (!policyFile) {
        showError("Please select an insurance policy PDF");
        return;
    }

    showLoading(true);

    const formData = new FormData();
    formData.append("file", policyFile);

    try {
        const response = await fetch("/billing/upload-policy", {
            method: "POST",
            body: formData
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.detail || "Policy upload failed");

        document.getElementById("policySummary").innerHTML = `
            <div class="policy-card">
                <strong style="font-size: 16px; color: #166534; display: block; margin-bottom: 12px;">‚úÖ Policy Loaded Successfully!</strong>
                <div style="color: #166534; font-size: 14px; line-height: 1.8;">
                    <div>üí∞ Co-payment: <strong>${data.co_payment_percentage}%</strong></div>
                    <div style="margin-top: 8px;">üè• Coverage: <strong>${Object.keys(data.coverage_limits).join(", ")}</strong></div>
                    <div style="margin-top: 8px;">‚ùå Exclusions: <strong>${data.exclusions.join(", ")}</strong></div>
                </div>
            </div>
        `;

    } catch (err) {
        showError("‚ùå " + err.message);
    }

    showLoading(false);
}

async function downloadReport() {
    if (!lastAnalysisData) {
        showError("No analysis data available. Please analyze a bill first.");
        return;
    }

    const downloadBtn = event.target;
    downloadBtn.disabled = true;
    downloadBtn.innerHTML = "üì• Preparing...";

    try {
        const response = await fetch("/billing/download-report", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(lastAnalysisData)
        });
        
        if (!response.ok) throw new Error("Failed to generate report");
        
        const blob = await response.blob();
        const link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);
        link.download = "MediExplain_Report.pdf";
        link.click();
        window.URL.revokeObjectURL(link.href);
        
        downloadBtn.innerHTML = "‚úÖ Downloaded!";
        setTimeout(() => {
            downloadBtn.disabled = false;
            downloadBtn.innerHTML = "üì• Download Report (PDF)";
        }, 2000);
    } catch (err) {
        showError("‚ùå Failed to download: " + err.message);
        downloadBtn.disabled = false;
        downloadBtn.innerHTML = "üì• Download Report (PDF)";
    }
}

async function askLLM() {
    const question = document.getElementById("userQuestion").value.trim();
    
    if (!question) {
        showError("Please enter a question about your bill");
        return;
    }

    if (!window.lastAnalysis) {
        showError("No analysis available. Please analyze a bill first.");
        return;
    }

    const qaLoading = document.getElementById("qaLoading");
    const qaAnswer = document.getElementById("qaAnswer");
    const askBtn = document.querySelector('#qaSection .submit-btn');
    
    qaLoading.style.display = "block";
    qaAnswer.style.display = "none";
    askBtn.disabled = true;
    clearError();

    try {
        const response = await fetch("/api/billing/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                question: question,
                analysis: window.lastAnalysis
            })
        });

        if (!response.ok) {
            throw new Error("Could not generate answer");
        }

        const data = await response.json();
        qaAnswer.innerHTML = `<strong>üí° Answer:</strong><br><div style="margin-top: 10px;">${(data.answer || '').replace(/\*+/g, '')}</div>`;
        qaAnswer.style.display = "block";
        
        // Clear input after successful response
        document.getElementById("userQuestion").value = "";
    } catch (err) {
        showError("‚ùå " + err.message);
    } finally {
        qaLoading.style.display = "none";
        askBtn.disabled = false;
    }
}

</script>

</body>
</html>